[](){#ref-software-cesm}
# CESM

!!! warning ""
    CESM is [user software][ref-support-user-apps] on Alps.
    This guide is provided based on our experiences helping users -- however we can't provide the same level of support as we do for [supported software][ref-support-apps].
    See the [main applications page][ref-software] for more information.

The [Coummunity Earth System Model (CESM)](https://www.cesm.ucar.edu/) is a fully coupled global Earth system model.

This guide demonstrates a uenv-based workflow that CSCS has developed with CESM users on [Eiger][ref-cluster-eiger].
Specifically, the workflow is for users of CESM version 3, which is currently in beta release, on multi-core x86 CPUs.

The uenv is named `esmf` because it provides all of the dependencies of CESM, of which the [Earth System Modeling Framework (ESMF)](https://earthsystemmodeling.org/) is the main dependency.

[](){#ref-uenv-cesm-versioning}
## Versioning

The naming scheme is `esmf/<version>`, where `<version>` has the `YY.M[M]` format, for example February 2026 is `26.2`.

### Versions

=== "26.2"

This version builds on top

- gcc@14.3.0
    - provides C, C++ and Fortran compilers.
- python@3.14.0
- cray-mpich@8.1.32
- libfabric@2.3.1

The following core dependencies are also provided:

- **esmf@8.8.0**
- **parallelio@2.6.6**
- hdf5@1.14.6
- netcdf-c@4.9.3
- netcdf-cxx@4.2
- netcdf-fortran@4.6.2
- openblas@0.3.30
- parallel-netcdf@1.14.1

[](){#ref-uenv-cesm-gnu-how-to-use}
## How to use

The uenv is based on the GNU compiler toolchain, and provides the cray-mpich implementation.

On Eiger, search for `esmf` images, which are in the service namespace:
```console
$ uenv image find service::esmf
uenv                  arch  system  id                size(MB)  date
esmf/26.2:2339541775  zen2  eiger   d3259510b826de5a     635    2026-02-20
$ uenv image pull service::esmf/26.2:2339541775
```

!!! note
    The uenv images in `service::` are currently test builds, hence the long tags.
    Once we have a released image, we will deploy it as `esmf/26.2:v1`.

The uenv must be loaded when configuring and building CESM use cases, and also when running those use cases.

Start the uenv with the `esmf` view loaded, and if this is your first time you can verify that key environment variables have been set by grepping for `NETCDF` and `ESMF` in the output of `printenv`:

```
$ uenv start --view=esmf esmf/26.2:v1
$ printenv | grep -e NETCDF -e ESMF
PNETCDF_PATH=/user-environment/env/esmf
ESMFMKFILE=/user-environment/env/esmf/lib/esmf.mk
NETCDF_PATH=/user-environment/env/esmf
```

!!! example "building CESM `cesm3_0_beta_7`"


    ```console
    # start the environment
    $ uenv start --view=esmf esmf/26.2:2339541775

    $ CESMROOT=$PWD/CESM

    # download CESM and check out the desired version
    $ cesm_version='cesm3_0_beta07'
    $ git clone https://github.com/ESCOMP/CESM.git $CESMROOT
    $ cd $CESMROOT;
    $ git checkout ${cesm_version}

    # configure dependencies
    $ ./bin/git-fleximod update

    # set up the machine file
    cp -rv /user-environment/meta/extra/machines/eiger $CESMROOT/ccs_config/machines/
    ```

    The last step copied machine configuration files for eiger from the uenv into the CESM source code.

    You will have to update the `config_machines.xml` file with relevant directories, and also check the `config_batch.xml` file.
    The `gnu_eiger.cmake` should not need modification - if it does, contact CSCS support (or Ben Cumming on CSCS user slack) to see whether we can update the configuration in future releases of the ESMF uenv image.

    Now it is time to configure the use case.
    Here we configure a simple 

    ```console
    $ cd $CESMROOT/cime/scripts
    $ ./create_newcase --case test_cscs \
                       --compset FHIST \
                       --res f09_g17 \
                       --machine eiger \
                       --run-unsupported \
                       --compiler gnu
    $ cd test_cscs
    $ ./case.setup
    $ ./case.build
    ```

!!! note
    The workflow above worked for the `FHIST` compset - it might need to be changed (and the uenv might need to be changed) to support your use case.

!!! warning
    The uenv must be loaded when SLURM jobs are launched, which requires that the correct flags are passed to srun.

    The flags to pass to srun are `srun --uenv=esmf/26.2:2339541775 --view=esmf` (modify this to match the version:tag of the image you are testing), which you can set by modifying the `env_mach_specific.xml` that is generated by `create_newcase` in your case directory, or by editing the original machine description.

    Once we have a final image, the machine configuration will be fixed to configure the released uenv version.
